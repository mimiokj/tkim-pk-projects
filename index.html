<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BE Sample Size Calculator & Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--primary-color); line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header { border-bottom: 2px solid var(--accent-color); margin-bottom: 30px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 8px; font-size: 0.9em; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; }
        .result-box { background: #eef2f7; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; }
        .result-value { font-size: 2em; font-weight: bold; color: var(--accent-color); }
        canvas { margin-top: 30px; max-height: 350px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-calc { background: var(--accent-color); color: white; }
        .btn-print { background: #95a5a6; color: white; }
        button:hover { opacity: 0.8; }
        .disclaimer { font-size: 0.8em; color: #7f8c8d; margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 10px; }
        @media print { .btn-group, .disclaimer { display: none; } .container { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>BE Sample Size Calculator</h2>
        <small>Bioequivalence Study Design</small>
    </header>

    <div class="input-grid">
        <div class="input-group">
            <label>Intra-subject CV (%)</label>
            <input type="number" id="cv" value="20" step="0.1">
        </div>
        <div class="input-group">
            <label>Expected GMR (T/R Ratio)</label>
            <input type="number" id="gmr" value="0.95" step="0.01">
        </div>
        <div class="input-group">
            <label>Target Power (%)</label>
            <select id="power">
                <option value="0.8">80%</option>
                <option value="0.9">90%</option>
            </select>
        </div>
        <div class="input-group">
            <label>Expected Dropout Rate (%)</label>
            <input type="number" id="dropout" value="10" step="1">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-calc" onclick="calculate()">계산하기 (Calculate)</button>
        <button class="btn-print" onclick="window.print()">결과 저장 (PDF/Print)</button>
    </div>

    <div class="result-box">
        <div id="resultText">필요한 샘플 수 (N): <span class="result-value">-</span></div>
        <div id="totalText" style="margin-top:10px; font-weight:bold;">총 모집 인원 (탈락률 반영): <span>-</span></div>
    </div>

    <canvas id="distChart"></canvas>

    <div class="disclaimer">
        * 본 계산기는 Diletti et al. (1991)의 공식을 기반으로 한 근사치를 제공합니다.<br>
        * 실제 시험 설계 시 반드시 통계 전문가 및 규제 가이드라인을 확인하시기 바랍니다.
    </div>
</div>

<script>
    let myChart;

    function calculate() {
        const cv = document.getElementById('cv').value / 100;
        const gmr = document.getElementById('gmr').value;
        const power = document.getElementById('power').value;
        const dropout = document.getElementById('dropout').value / 100;

        // 1. 샘플 수 계산 (Diletti's Approx Method)
        // BE 기준: ln(0.8) ~ ln(1.25)
        const alpha = 0.05;
        const z_alpha = 1.645; // 90% CI
        const z_beta = (power == 0.8) ? 0.842 : 1.282;
        
        const sigma_sq = Math.log(cv**2 + 1);
        const diff = Math.min(Math.abs(Math.log(gmr) - Math.log(0.8)), Math.abs(Math.log(1.25) - Math.log(gmr)));
        
        let n = (2 * (z_alpha + z_beta)**2 * sigma_sq) / (Math.pow(Math.log(1.25) - Math.abs(Math.log(gmr)), 2));
        n = Math.ceil(n);
        if (n % 2 !== 0) n++; // Crossover 설계이므로 짝수 맞춤
        if (n < 12) n = 12; // 최소 권장 인원

        const totalN = Math.ceil(n / (1 - dropout));

        document.querySelector('#resultText span').innerText = n;
        document.querySelector('#totalText span').innerText = totalN;

        updateChart(gmr);
    }

    function updateChart(gmr) {
        const ctx = document.getElementById('distChart').getContext('2d');
        const labels = [];
        const data = [];
        const logGMR = Math.log(gmr);
        const lower = Math.log(0.8);
        const upper = Math.log(1.25);
        
        // 정규분포 곡선 데이터 생성 (log scale)
        for (let x = -0.5; x <= 0.5; x += 0.01) {
            labels.push(Math.exp(x).toFixed(2));
            const y = Math.exp(-0.5 * Math.pow(x / 0.15, 2)); // 시각화를 위한 임의 표준편차 0.15
            data.push(y);
        }

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Acceptance Range (0.8 - 1.25)',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    pointRadius: 0,
                    segment: {
                        backgroundColor: ctx => {
                            const val = parseFloat(labels[ctx.p0DataIndex]);
                            return (val >= 0.8 && val <= 1.25) ? 'rgba(52, 152, 219, 0.5)' : 'rgba(200, 200, 200, 0.1)';
                        }
                    }
                }]
            },
            options: {
                plugins: {
                    legend: { display: true },
                    tooltip: { enabled: true }
                },
                scales: {
                    x: { title: { display: true, text: 'T/R Ratio (Geometric Mean)' } },
                    y: { display: false }
                }
            }
        });
    }

    // 초기 실행
    window.onload = calculate;
</script>

</body>
</html>
