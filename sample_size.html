<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PK/BE Sample Size Calculator | 대웅제약</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            /* 대웅제약 브랜드 컬러 적용 */
            --primary-color: #54565A; /* 대웅제약 로고 그레이 */
            --accent-color: #FF7A00;  /* 대웅제약 로고 오렌지 */
            --success-color: #27ae60; 
            --bg-color: #f4f6f9;      
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
        }

        /* 헤더 스타일 */
        .app-header {
            background: white;
            border-bottom: 3px solid var(--accent-color);
            padding: 1.2rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 2rem;
        }
        .brand-logo-img {
            height: 45px; /* 로고 높이 */
            width: auto;
            margin-right: 15px;
        }
        .brand-sub {
            font-size: 0.9rem;
            color: #888;
            font-weight: 600;
            padding-left: 15px;
            border-left: 2px solid #eee;
        }

        /* 카드 공통 스타일 */
        .custom-card {
            background: white;
            border-radius: 16px;
            border: none;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            transition: transform 0.2s;
        }
        
        /* 탭 스타일 */
        .nav-pills .nav-link {
            color: var(--primary-color);
            font-weight: 600;
            border-radius: 12px;
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #f1f3f5;
            transition: all 0.3s ease;
        }
        .nav-pills .nav-link.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 122, 0, 0.3);
        }

        /* 입력 폼 스타일 */
        .form-floating > .form-control {
            border-radius: 12px;
            border: 1px solid #e1e4e8;
            height: 60px;
        }
        .form-floating > .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.15);
        }

        /* 버튼 스타일 */
        .btn-calc {
            background: linear-gradient(135deg, var(--accent-color), #FF5733);
            color: white;
            font-weight: 800;
            padding: 16px 30px;
            border-radius: 12px;
            width: 100%;
            font-size: 1.1rem;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 122, 0, 0.3);
            transition: all 0.3s ease;
        }
        .btn-calc:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 122, 0, 0.4);
        }

        /* 결과 섹션 */
        .result-section {
            margin-top: 2rem;
            display: none; 
            animation: slideUp 0.5s ease forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #edf2f7;
            box-shadow: var(--card-shadow);
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        .result-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 6px; height: 100%;
        }
        .card-cv::before { background-color: var(--accent-color); }
        .card-n::before { background-color: var(--success-color); }

        .result-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .result-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-color);
        }
        .unit { font-size: 1rem; color: #999; font-weight: 500; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="logo.png" alt="대웅제약 로고" class="brand-logo-img" onerror="this.style.display='none'">
                <div>
                    <span class="fs-4 fw-bold" style="color: var(--primary-color); letter-spacing: -1px;">PK/BE Simulator</span>
                    <span class="brand-sub">Pro Ver.</span>
                </div>
            </div>
            <div>
                <span class="text-secondary small fw-bold">
                    <i class="bi bi-person-circle me-1" style="color: var(--accent-color);"></i> 김태헌 박사
                </span>
            </div>
        </div>
    </header>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                
                <div class="custom-card">
                    <h4 class="fw-bold mb-4" style="color: var(--primary-color);">
                        <i class="bi bi-sliders me-2" style="color: var(--accent-color);"></i>Study Design Parameters
                    </h4>
                    
                    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-ci-tab" data-bs-toggle="pill" data-bs-target="#pills-ci" type="button">
                                <i class="bi bi-journal-text me-1"></i> 문헌 CI 기반
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-mean-tab" data-bs-toggle="pill" data-bs-target="#pills-mean" type="button">
                                <i class="bi bi-bar-chart-fill me-1"></i> Mean/SD 기반
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="pills-ci" role="tabpanel">
                            <div class="alert alert-light border-0 small mb-4" style="background-color: #FFF4E6; color: #d35400;">
                                <i class="bi bi-info-circle-fill me-2" style="color: var(--accent-color);"></i> 논문에 기재된 90% 신뢰구간(Confidence Interval)을 입력하세요.
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="lowerCI" placeholder="80" step="0.1">
                                        <label for="lowerCI">Lower Limit (%)</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="upperCI" placeholder="125" step="0.1">
                                        <label for="upperCI">Upper Limit (%)</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="nLit" placeholder="24">
                                        <label for="nLit">문헌 내 피험자 수 (N)</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="pills-mean" role="tabpanel">
                            <div class="alert alert-light border-0 small mb-4" style="background-color: #FFF4E6; color: #d35400;">
                                <i class="bi bi-info-circle-fill me-2" style="color: var(--accent-color);"></i> 로그변환 전의 산술 평균(Arithmetic Mean)과 표준편차(SD)를 입력하세요.
                            </div>
                            <div class="row g-3">
                                <div class="col-6">
                                    <h6 class="small fw-bold mb-2" style="color: var(--primary-color);">Test Drug</h6>
                                    <div class="form-floating mb-2">
                                        <input type="number" class="form-control" id="meanT" placeholder="Mean">
                                        <label>Mean</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="sdT" placeholder="SD">
                                        <label>SD</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 class="small fw-bold mb-2" style="color: var(--primary-color);">Reference Drug</h6>
                                    <div class="form-floating mb-2">
                                        <input type="number" class="form-control" id="meanR" placeholder="Mean">
                                        <label>Mean</label>
                                    </div>
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="sdR" placeholder="SD">
                                        <label>SD</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2">
                        <button onclick="calculate()" class="btn-calc">
                            <i class="bi bi-calculator me-2"></i> Analyze & Calculate Sample Size
                        </button>
                    </div>
                </div> 

                <div id="resultSection" class="result-section">
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="result-card card-cv">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="result-label" style="color: var(--accent-color);">Estimated Intra-CV</div>
                                        <div class="result-value" id="calcCV">0.0<span class="unit">%</span></div>
                                    </div>
                                    <i class="bi bi-activity fs-1 opacity-25" style="color: var(--accent-color);"></i>
                                </div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-check-circle-fill me-1" style="color: var(--accent-color);"></i> 문헌 데이터를 역산한 결과
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="result-card card-n">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="result-label" style="color: var(--success-color);">Recommended N</div>
                                        <div class="result-value" id="recN">0<span class="unit">명</span></div>
                                    </div>
                                    <i class="bi bi-people-fill fs-1 opacity-25" style="color: var(--success-color);"></i>
                                </div>
                                
                                <div class="mt-3 bg-light p-2 rounded d-flex gap-2">
                                    <select id="targetPower" class="form-select form-select-sm border-0 fw-bold" style="color: var(--primary-color);" onchange="recalcN()">
                                        <option value="0.8">Power 80%</option>
                                        <option value="0.9" selected>Power 90%</option>
                                    </select>
                                    <select id="targetGMR" class="form-select form-select-sm border-0 fw-bold" style="color: var(--primary-color);" onchange="recalcN()">
                                        <option value="0.95" selected>GMR 0.95</option>
                                        <option value="1.0">GMR 1.00</option>
                                        <option value="0.9">GMR 0.90</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="custom-card py-4" style="border-left: 4px solid var(--primary-color);">
                        <h6 class="fw-bold mb-3" style="color: var(--primary-color);"><i class="bi bi-clipboard-data me-2" style="color: var(--accent-color);"></i>Analysis Insight</h6>
                        <p class="text-muted mb-0 small">
                            현재 입력된 문헌 데이터는 <strong id="cvRating" style="color: var(--accent-color);"></strong> 변동성을 보입니다. 
                            안전한 BE 성공을 위해 최소 <strong id="finalN" class="fs-5" style="color: var(--success-color);"></strong>명 이상의 피험자가 권장됩니다.
                            (2x2 Crossover Design, α=0.05 기준)
                        </p>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <script>
        let currentCV = 0;

        function calculate() {
            const activeTab = document.querySelector('.nav-link.active').id;
            if (activeTab === 'pills-ci-tab') {
                calculateFromCI();
            } else {
                calculateFromMeanSD();
            }
        }

        function calculateFromCI() {
            let L = parseFloat(document.getElementById('lowerCI').value);
            let U = parseFloat(document.getElementById('upperCI').value);
            let N = parseFloat(document.getElementById('nLit').value);

            if (!L || !U || !N) { alert("모든 값을 입력해주세요."); return; }

            // Logic: CV = sqrt( exp( ( (lnU - lnL) / (2 * t_crit) )^2 * N/2 ) - 1 )
            let t_dist = 2.0; 
            if(N > 50) t_dist = 1.96;
            else if(N > 20) t_dist = 2.07;
            
            let lnU = Math.log(U/100);
            let lnL = Math.log(L/100);
            let diff = lnU - lnL;
            let se = diff / (2 * 1.71); 
            let mse = Math.pow(se, 2) * N / 2;
            let cv = Math.sqrt(Math.exp(mse) - 1);
            
            showResult(cv * 100);
        }

        function calculateFromMeanSD() {
            let mT = parseFloat(document.getElementById('meanT').value);
            let sT = parseFloat(document.getElementById('sdT').value);
            let mR = parseFloat(document.getElementById('meanR').value);
            let sR = parseFloat(document.getElementById('sdR').value);

            if (!mT || !sT || !mR || !sR) { alert("모든 값을 입력해주세요."); return; }

            let cvT = sT / mT;
            let cvR = sR / mR;
            let pooledCV = Math.sqrt((cvT*cvT + cvR*cvR) / 2);

            showResult(pooledCV * 100);
        }

        function calculateSampleSize(cv, powerTarget, gmr) {
            let sigma = Math.sqrt(Math.log(cv*cv + 1));
            let t_alpha = 1.68; 
            let t_beta = (powerTarget === 0.9) ? 1.3 : 0.85; 
            let effect = Math.log(1.25) - Math.abs(Math.log(gmr));
            if (effect <= 0) effect = 0.01;

            let estimatedN = 2 * Math.pow((t_alpha + t_beta) * sigma / effect, 2);
            return Math.ceil(estimatedN);
        }

        function showResult(cvVal) {
            currentCV = cvVal / 100;
            
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('calcCV').innerHTML = cvVal.toFixed(2) + '<span class="unit">%</span>';
            
            let rating = "보통 수준의";
            if(cvVal > 30) rating = "상당히 높은(High)";
            else if(cvVal < 15) rating = "매우 낮은(Low)";
            document.getElementById('cvRating').innerText = rating;

            recalcN();
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function recalcN() {
            if(currentCV === 0) return;
            let power = parseFloat(document.getElementById('targetPower').value);
            let gmr = parseFloat(document.getElementById('targetGMR').value);
            
            let n = calculateSampleSize(currentCV, power, gmr);
            if(n % 2 !== 0) n += 1;
            if(n < 12) n = 12;

            document.getElementById('recN').innerHTML = n + '<span class="unit">명</span>';
            document.getElementById('finalN').innerText = n;
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
